<div th:fragment="scriptsFragment">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/rowgroup/1.4.1/css/rowGroup.dataTables.min.css">
    <script src="https://cdn.datatables.net/rowgroup/1.4.1/js/dataTables.rowGroup.min.js"></script>

    <script src="/js/dashboard.js"></script>

    <style>
        .group-pagination {
            display: flex; justify-content: space-between; align-items: center;
            margin: 10px 0; background: #f8f9fa; padding: 10px;
            border-radius: 4px; border: 1px solid #ddd; gap: 10px;
        }
        .group-btn {
            padding: 5px 15px; cursor: pointer; background-color: #27ae60;
            color: white; border: none; border-radius: 4px; font-weight: bold;
        }
        .group-btn:hover { background-color: #219150; }
        .group-btn.secondary { background-color: #6c757d; }
        .group-btn:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.7; }
        .group-info { font-weight: bold; font-size: 1.1em; flex-grow: 1; text-align: center; }
        div.dataTables_wrapper { width: 100%; }
        .dt-buttons { margin-bottom: 15px; }
    </style>

    <script th:inline="none">
        $(document).ready(function() {
            console.log("--- START SKRYPTU ---");

            // WAŻNE: Czyścimy stare filtry DataTables, żeby się nie dublowały przy przeładowaniu fragmentów
            $.fn.dataTable.ext.search = [];

            // --- KONFIGURACJA WSPÓLNA ---
            const commonSettings = {
                "dom": 'Bfrtip',
                "buttons": [
                    { extend: 'excelHtml5', className: 'btn', exportOptions: { columns: ':not(:last-child)' } },
                    { extend: 'print', className: 'btn', exportOptions: { columns: ':not(:last-child)' } }
                ],
                "language": {
                    "processing": "Przetwarzanie...", "search": "Szukaj:", "lengthMenu": "Pokaż _MENU_ pozycji",
                    "info": "Pozycje od _START_ do _END_ z _TOTAL_ łącznie", "infoEmpty": "Brak danych",
                    "infoFiltered": "(filtrowanie z _MAX_)", "loadingRecords": "Wczytywanie...",
                    "zeroRecords": "Brak danych", "paginate": { "first": "<<", "previous": "<", "next": ">", "last": ">>" },
                    "emptyTable": "Brak danych"
                },
                "columnDefs": [ { "orderable": false, "targets": -1 } ]
            };

            function getSettings(placeholder) {
                let s = $.extend(true, {}, commonSettings);
                s.language.search = placeholder;
                return s;
            }

            // ============================================================
            // 1. TABELA PRACOWNIKA (My Work Hours)
            // ============================================================
            if ($('#myWorkHoursTable').length > 0) {
                (function() { // Izolacja zmiennych (IIFE)
                    console.log("Inicjalizacja myWorkHoursTable...");
                    let tableId = 'myWorkHoursTable';

                    let settings = getSettings("Szukaj w historii:");
                    settings.paging = false;
                    settings.dom = 'Bfrt';
                    settings.columnDefs = [
                        { "visible": false, "targets": 0 }, // Kolumna Grupy (0) ukryta
                        { "orderable": false, "targets": -1 }
                    ];
                    settings.order = [[1, 'desc']]; // Sortowanie po dacie

                    settings.rowGroup = {
                        dataSrc: 0,
                        startRender: function (rows, group) {
                            return $('<tr/>').append('<td colspan="10" style="background-color: #e0e0e0; font-weight: bold;">' +
                                'Tydzień: ' + group + ' (' + rows.count() + ' wpisów)' +
                                '</td>');
                        }
                    };

                    let table = $('#' + tableId).DataTable(settings);

                    // --- LOGIKA POBIERANIA GRUP ---
                    // Pobieramy dane z kolumny 0, nawet jeśli jest ukryta
                    let rawData = table.column(0).data().toArray();
                    let uniqueGroups = [];

                    // Czyścimy dane (trim) i usuwamy duplikaty
                    $.each(rawData, function(i, val){
                        // Usuwamy HTML tagi jeśli są, i białe znaki
                        let textVal = val ? String(val).replace(/<[^>]+>/g, '').trim() : "";
                        if(textVal && $.inArray(textVal, uniqueGroups) === -1) {
                            uniqueGroups.push(textVal);
                        }
                    });

                    console.log("TABELA PRACOWNIKA - Znalezione grupy:", uniqueGroups);

                    if(uniqueGroups.length > 0) {
                        let currentIndex = 0;
                        let showAll = false;

                        // Dodajemy HTML nawigacji
                        let navHtml = `
                            <div class="group-pagination">
                                <button id="btn-prev-my" class="group-btn" type="button">&laquo; Starsze</button>
                                <span id="display-my" class="group-info">Ładowanie...</span>
                                <button id="btn-next-my" class="group-btn" type="button">Nowsze &raquo;</button>
                                <button id="btn-all-my" class="group-btn secondary" type="button">Pokaż wszystko</button>
                            </div>
                        `;
                        $('#' + tableId + '_wrapper').prepend(navHtml);

                        // Dodajemy filtr do DataTables
                        $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                            if (settings.nTable.id !== tableId) return true;
                            if (showAll) return true;

                            // data[0] to wartość z kolumny 0 (grupa)
                            let rowVal = data[0] ? String(data[0]).replace(/<[^>]+>/g, '').trim() : "";
                            return rowVal === uniqueGroups[currentIndex];
                        });

                        // Funkcja odświeżająca przyciski
                        function updateView() {
                            if (showAll) {
                                $('#display-my').text("Wszystkie tygodnie (" + uniqueGroups.length + ")");
                                $('#btn-prev-my, #btn-next-my').prop('disabled', true);
                                $('#btn-all-my').text("Pokaż jeden tydzień");
                            } else {
                                $('#display-my').text(uniqueGroups[currentIndex]);
                                // Logic: index 0 = Najnowszy. index MAX = Najstarszy.
                                // Przycisk "Starsze" (idziemy w górę indeksu)
                                $('#btn-prev-my').prop('disabled', currentIndex >= uniqueGroups.length - 1);
                                // Przycisk "Nowsze" (idziemy w dół indeksu)
                                $('#btn-next-my').prop('disabled', currentIndex <= 0);
                                $('#btn-all-my').text("Pokaż wszystko");
                            }
                            table.draw(); // Przerysowanie tabeli uruchamia filtr
                        }

                        // Obsługa kliknięć
                        $(document).on('click', '#btn-all-my', function() { showAll = !showAll; updateView(); });
                        $(document).on('click', '#btn-prev-my', function() {
                            if (!showAll && currentIndex < uniqueGroups.length - 1) { currentIndex++; updateView(); }
                        });
                        $(document).on('click', '#btn-next-my', function() {
                            if (!showAll && currentIndex > 0) { currentIndex--; updateView(); }
                        });

                        // Start
                        updateView();
                    } else {
                        console.warn("TABELA PRACOWNIKA: Brak unikalnych grup. Nawigacja nie została dodana.");
                    }
                })();
            }
// --- TABELA DO WYPŁATY (Z GRUPOWANIEM MIESIĘCZNYM I CHECKBOXAMI) ---
            if ($('#PayoutsTable').length > 0) {
                var payoutsSettings = getSettings("Szukaj wypłaty:");
                payoutsSettings.paging = false; // Wyświetl wszystko na jednej stronie dla łatwego zaznaczania
                payoutsSettings.dom = 'Bfrt';

                // Konfiguracja kolumn
                payoutsSettings.columnDefs = [
                    { "orderable": false, "targets": 0 }, // Checkbox - bez sortowania
                    { "visible": false, "targets": 1 },   // Ukryj kolumnę miesiąca (używana do grupowania)
                    { "orderable": false, "targets": -1 } // Akcje - bez sortowania
                ];

                // Domyślne sortowanie po dacie (kolumna 4) malejąco
                payoutsSettings.order = [[4, 'desc']];

                // Grupowanie
                payoutsSettings.rowGroup = {
                    dataSrc: 1, // Grupuj po kolumnie 1 (Miesiąc YYYY-MM)
                    startRender: function (rows, group) {
                        // Dodajemy też checkbox do nagłówka grupy, aby zaznaczyć cały miesiąc
                        return $('<tr/>').append('<td colspan="9" style="background-color: #e0e0e0; font-weight: bold; cursor: pointer;" class="group-header-row">' +
                            '<input type="checkbox" class="group-checkbox" style="margin-right: 10px;">' +
                            'Miesiąc: ' + group + ' (' + rows.count() + ' pozycji)' +
                            '</td>');
                    }
                };

                var payoutsTable = $('#PayoutsTable').DataTable(payoutsSettings);

                // --- OBSŁUGA CHECKBOXÓW ---

                function updateBulkActions() {
                    var selectedIds = [];

                    // Zbieramy wszystkie zaznaczone checkboxy (tylko z widocznych wierszy)
                    $('.payout-checkbox:checked').each(function() {
                        selectedIds.push($(this).val());
                    });

                    // Aktualizacja licznika
                    $('#selectedCount').text(selectedIds.length);

                    // Pokaż/Ukryj pasek akcji
                    if (selectedIds.length > 0) {
                        $('#bulkActionsBar').css('display', 'flex');
                    } else {
                        $('#bulkActionsBar').hide();
                    }

                    // Wstrzyknij ukryte inputy do formularzy (status i delete)
                    var statusInputsHtml = '';
                    var deleteInputsHtml = '';

                    selectedIds.forEach(function(id) {
                        // Spring binduje List<Long> ids jeśli inputy mają tę samą nazwę "ids"
                        statusInputsHtml += '<input type="hidden" name="ids" value="' + id + '">';
                        deleteInputsHtml += '<input type="hidden" name="ids" value="' + id + '">';
                    });

                    $('#bulkStatusInputs').html(statusInputsHtml);
                    $('#bulkDeleteInputs').html(deleteInputsHtml);
                }

                // 1. Zaznaczanie pojedynczego wiersza
                $(document).on('change', '.payout-checkbox', function() {
                    updateBulkActions();
                });

                // 2. Zaznaczanie "Select All" w nagłówku tabeli
                $('#selectAllCheckbox').on('click', function() {
                    var isChecked = $(this).is(':checked');
                    $('.payout-checkbox').prop('checked', isChecked);
                    $('.group-checkbox').prop('checked', isChecked);
                    updateBulkActions();
                });

                // 3. Zaznaczanie całej grupy (Miesiąca)
                $(document).on('click', '.group-checkbox', function(e) {
                    e.stopPropagation(); // Żeby nie zwijało grupy (jeśli masz zwijanie)
                    var isChecked = $(this).is(':checked');
                    // Znajdź wszystkie wiersze w tej grupie
                    // DataTables rowGroup nie daje prostej metody "getRowsInGroup", więc robimy to przez DOM
                    var groupRow = $(this).closest('tr');
                    var nextRows = groupRow.nextUntil('tr.dtrg-group'); // Wszystkie wiersze do następnej grupy

                    nextRows.find('.payout-checkbox').prop('checked', isChecked);
                    updateBulkActions();
                });
            }

            // ============================================================
            // TABELA RAPORTU WYNAGRODZEŃ (ADMIN)
            // ============================================================
            if ($('#salaryOverviewTable').length > 0) {
                var salaryTable = $('#salaryOverviewTable').DataTable({
                    dom: 'Bfrtip',
                    buttons: [
                        { extend: 'excelHtml5', className: 'btn', text: 'Eksportuj do Excel' },
                        { extend: 'print', className: 'btn', text: 'Drukuj' }
                    ],
                    paging: false, // Показываем всех на одной странице
                    columnDefs: [
                        { "visible": false, "targets": [0, 1] } // Скрываем колонки Dział(0) и Stanowisko(1)
                    ],
                    order: [[0, 'asc']], // Изначальная сортировка по Отделу
                    rowGroup: {
                        dataSrc: 0, // Группируем по колонке 0 (Dział)
                        startRender: function (rows, group) {
                            // Подсчет средней ставки в группе (опционально)
                            var avgSalary = rows
                                .data()
                                .pluck(5) // Берем колонку 5 (Stawka)
                                .map(function(val) {
                                    return parseFloat(val.replace(' PLN', '')) || 0;
                                })
                                .average();

                            return $('<tr/>').append('<td colspan="4" style="background-color: #d1ecf1; color: #0c5460; font-weight: bold;">' +
                                group + ' (Pracowników: ' + rows.count() + ') | Średnia stawka: ' + avgSalary.toFixed(2) + ' PLN' +
                                '</td>');
                        }
                    }
                });

                // Логика переключения группировки кнопками
                $('#group-by-dept').on('click', function() {
                    salaryTable.rowGroup().dataSrc(0); // Группировка по Dział
                    salaryTable.order([0, 'asc']).draw();

                    // Обновляем стили кнопок
                    $(this).removeClass('secondary').addClass('group-btn');
                    $('#group-by-pos').removeClass('group-btn').addClass('secondary');
                });

                $('#group-by-pos').on('click', function() {
                    salaryTable.rowGroup().dataSrc(1); // Группировка по Stanowisko
                    salaryTable.order([1, 'asc']).draw();

                    // Обновляем стили кнопок
                    $(this).removeClass('secondary').addClass('group-btn');
                    $('#group-by-dept').removeClass('group-btn').addClass('secondary');
                });
            }



            // ============================================================
            // 2. TABELA KSIĘGOWEGO (All Work Hours)
            // ============================================================
            if ($('#WorkHoursTable').length > 0) {
                (function() {
                    console.log("Inicjalizacja WorkHoursTable (Księgowy)...");
                    let tableId = 'WorkHoursTable';

                    let settings = getSettings("Szukaj w historii:");
                    settings.paging = false;
                    settings.dom = 'Bfrt';
                    settings.columnDefs = [
                        { "visible": false, "targets": 0 },
                        { "orderable": false, "targets": -1 }
                    ];
                    settings.order = [[3, 'desc']]; // Sort po dacie (kolumna 3)

                    settings.rowGroup = {
                        dataSrc: 0,
                        startRender: function (rows, group) {
                            return $('<tr/>').append('<td colspan="11" style="background-color: #e0e0e0; font-weight: bold;">' +
                                'Tydzień: ' + group + ' (' + rows.count() + ' wpisów)' +
                                '</td>');
                        }
                    };

                    let table = $('#' + tableId).DataTable(settings);

                    // Logika grup
                    let rawData = table.column(0).data().toArray();
                    let uniqueGroups = [];
                    $.each(rawData, function(i, val){
                        let textVal = val ? String(val).replace(/<[^>]+>/g, '').trim() : "";
                        if(textVal && $.inArray(textVal, uniqueGroups) === -1) {
                            uniqueGroups.push(textVal);
                        }
                    });

                    console.log("TABELA KSIĘGOWEGO - Znalezione grupy:", uniqueGroups);

                    if(uniqueGroups.length > 0) {
                        let currentIndex = 0;
                        let showAll = false;

                        let navHtml = `
                            <div class="group-pagination">
                                <button id="btn-prev-all" class="group-btn" type="button">&laquo; Starsze</button>
                                <span id="display-all" class="group-info">Ładowanie...</span>
                                <button id="btn-next-all" class="group-btn" type="button">Nowsze &raquo;</button>
                                <button id="btn-all-all" class="group-btn secondary" type="button">Pokaż wszystko</button>
                            </div>
                        `;
                        $('#' + tableId + '_wrapper').prepend(navHtml);

                        $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                            if (settings.nTable.id !== tableId) return true;
                            if (showAll) return true;
                            let rowVal = data[0] ? String(data[0]).replace(/<[^>]+>/g, '').trim() : "";
                            return rowVal === uniqueGroups[currentIndex];
                        });

                        function updateView() {
                            if (showAll) {
                                $('#display-all').text("Wszystkie tygodnie (" + uniqueGroups.length + ")");
                                $('#btn-prev-all, #btn-next-all').prop('disabled', true);
                                $('#btn-all-all').text("Pokaż jeden tydzień");
                            } else {
                                $('#display-all').text(uniqueGroups[currentIndex]);
                                $('#btn-prev-all').prop('disabled', currentIndex >= uniqueGroups.length - 1);
                                $('#btn-next-all').prop('disabled', currentIndex <= 0);
                                $('#btn-all-all').text("Pokaż wszystko");
                            }
                            table.draw();
                        }

                        $(document).on('click', '#btn-all-all', function() { showAll = !showAll; updateView(); });
                        $(document).on('click', '#btn-prev-all', function() {
                            if (!showAll && currentIndex < uniqueGroups.length - 1) { currentIndex++; updateView(); }
                        });
                        $(document).on('click', '#btn-next-all', function() {
                            if (!showAll && currentIndex > 0) { currentIndex--; updateView(); }
                        });

                        updateView();
                    } else {
                        console.warn("TABELA KSIĘGOWEGO: Brak unikalnych grup.");
                    }
                })();
            }

            // ============================================================
            // 3. INNE TABELE
            // ============================================================
            // Inicjalizacja reszty tabel...
            var usersTable = $('#myUsersTable').DataTable(commonSettings);
            $('#statusFilter').on('change', function() {
                usersTable.column(6).search($(this).val()).draw();
            });

            $('#projectsTable').DataTable(getSettings("Szukaj projektu:"));
            $('#workTypesTable').DataTable(getSettings("Szukaj typu pracy:"));
            $('#myDepartmentsTable').DataTable(getSettings("Szukaj działu:"));
            $('#myPositionsTable').DataTable(getSettings("Szukaj stanowiska:"));
            $('#myRolesTable').DataTable(getSettings("Szukaj roli:"));
            $('#approvalsTable').DataTable(getSettings("Szukaj pracownika:"));
            $('#PaymentTypesTable').DataTable(getSettings("Szukaj typu wypłaty:"));
            $('#PaymentStatusesTable').DataTable(getSettings("Szukaj statusu wypłaty:"));
            $('#SalaryChangeHistoryTable').DataTable(getSettings("Szukaj w historii zmian:"));
            $('#AllPaymentsTable').DataTable(getSettings("Szukaj w historii wypłat:"));


            $('#statsTable').DataTable({
                "paging": false, "searching": false, "ordering": false,
                "info": false, "dom": 't', "language": { "emptyTable": "Brak danych" }
            });

            $('.dt-project-users').DataTable({ "dom": 'ftp', "pageLength": 5, "language": commonSettings.language, "width": "100%" });
            $('.dt-current-members').DataTable({ "paging": false, "searching": false, "info": false, "dom": 't', "language": { "emptyTable": "Brak członków" }, "width": "100%" });
            $('.dt-approvals').DataTable({ "dom": 'tp', "pageLength": 10, "language": { "emptyTable": "Brak godzin", "paginate": { "first": "<<", "previous": "<", "next": ">", "last": ">>" } }, "width": "100%" });

            $('.tablinks').on('click', function() {
                setTimeout(function() {
                    $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust();
                }, 100);
            });
        });
    </script>
</div>